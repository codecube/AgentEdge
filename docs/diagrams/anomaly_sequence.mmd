%%{init: {'theme': 'dark', 'themeVariables': {'actorBkg': '#151d2e', 'actorBorder': '#334155', 'actorTextColor': '#e2e8f0', 'signalColor': '#94a3b8', 'signalTextColor': '#e2e8f0', 'labelBoxBkgColor': '#111827', 'labelBoxBorderColor': '#1e293b', 'labelTextColor': '#94a3b8', 'loopTextColor': '#64748b', 'noteBkgColor': '#1a2438', 'noteBorderColor': '#334155', 'noteTextColor': '#94a3b8', 'activationBkgColor': '#1a2438', 'activationBorderColor': '#475569', 'sequenceNumberColor': '#00f0ff'}}}%%

sequenceDiagram
    autonumber

    participant ARD as Arduino<br/>ENS160+AHT21
    participant MCP as MCP Server
    participant LOOP as Sensor Loop
    participant JET as Jetson ADK Agent
    participant LFM_J as Ollama/LFM (Jetson)
    participant MAC as Mac ADK Agent
    participant LFM_M as Ollama/LFM (Mac)
    participant DASH as Dashboard

    rect rgb(17, 24, 39)
        Note over ARD,DASH: Normal Operation (every 10s)
        ARD->>MCP: {"temp":24.5,"humidity":65.2,"eco2":450,"tvoc":120,"aqi":1}
        MCP->>LOOP: read_sensor → sensor data + timestamp
        LOOP->>LOOP: detect_anomalies: all thresholds OK
        LOOP->>MAC: REST POST /api/sensor/push
        MAC->>MAC: Store + update history
        MAC-->>DASH: WebSocket: sensor data
    end

    rect rgb(30, 15, 15)
        Note over ARD,DASH: Anomaly Detected! (eCO2 > 1000ppm)
        ARD->>MCP: {"temp":24.8,"humidity":66.0,"eco2":1200,"tvoc":380,"aqi":3}
        MCP->>LOOP: read_sensor → sensor data + timestamp
        LOOP->>LOOP: ANOMALY: eCO2 1200ppm > 1000 threshold

        LOOP->>MAC: REST POST /api/sensor/push (with anomaly)
        LOOP-->>DASH: WebSocket: anomaly_detected

        Note over DASH,MAC: User asks about the anomaly via chat
        DASH->>MAC: A2A message/send (JSON-RPC)
        MAC->>MAC: LlmAgent: query historical stats via tools
        MAC->>LFM_M: LiteLLM → Ollama: analyze with context
        LFM_M-->>MAC: "eCO2 is 2.1σ above mean. Recommend ventilation check"

        MAC->>JET: RemoteA2aAgent → A2A JSON-RPC (delegate for live reading)
        JET->>LFM_J: LiteLLM → Ollama: analyze anomaly
        LFM_J-->>JET: "CO2 spike while temp stable suggests poor ventilation"
        JET-->>MAC: A2A response with Jetson analysis

        MAC-->>DASH: A2A response: combined analysis
    end
