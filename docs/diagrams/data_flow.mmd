%%{init: {'theme': 'dark', 'themeVariables': {'primaryColor': '#151d2e', 'primaryTextColor': '#e2e8f0', 'primaryBorderColor': '#334155', 'lineColor': '#475569', 'edgeLabelBackground': '#111827'}}}%%

flowchart LR
    subgraph SENSOR["Sensor Layer"]
        S1["ENS160+AHT21<br/><i>I2C Bus</i>"]
    end

    subgraph ARDUINO_LAYER["Arduino"]
        A1["Serial JSON Output"]
    end

    subgraph MCP_LAYER["MCP Server"]
        M1["read_sensor tool"]
    end

    subgraph JETSON_LAYER["Jetson Agent"]
        J1["Sensor Loop<br/><i>every 10s</i>"]
        J2["Anomaly Check"]
        J3["ADK LlmAgent<br/><i>detect_anomalies tool</i>"]
    end

    subgraph MAC_LAYER["Mac Agent"]
        MM1["REST /api/sensor/push<br/><i>Store + History</i>"]
        MM2["ADK LlmAgent<br/><i>compute_statistics tool</i>"]
        MM3["RemoteA2aAgent<br/><i>delegates to Jetson</i>"]
    end

    subgraph DASH_LAYER["Dashboard"]
        D1["REST /api/history<br/><i>Sensor Charts</i>"]
        D2["REST /api/messages<br/><i>A2A Feed</i>"]
        D3["A2A message/send<br/><i>Chat Widget</i>"]
    end

    S1 -->|"temp, humidity<br/>eco2, tvoc, aqi"| A1
    A1 -->|"JSON @ 9600 baud"| M1
    M1 -->|"MCP stdio"| J1

    J1 --> J2
    J2 -->|"All readings"| J3
    J1 -->|"REST push"| MM1

    MM1 --> MM2
    MM3 -->|"A2A JSON-RPC"| J3

    MM1 -->|"REST"| D1
    MM1 -->|"REST"| D2
    D3 -->|"A2A JSON-RPC"| MM2

    style S1 fill:#1a2438,stroke:#00f0ff,stroke-width:2px,color:#e2e8f0
    style A1 fill:#1a2438,stroke:#22c55e,stroke-width:2px,color:#e2e8f0
    style M1 fill:#1a2438,stroke:#22c55e,stroke-width:2px,color:#e2e8f0
    style J1 fill:#151d2e,stroke:#00f0ff,stroke-width:1px,color:#94a3b8
    style J2 fill:#151d2e,stroke:#ff3366,stroke-width:2px,color:#e2e8f0
    style J3 fill:#151d2e,stroke:#00f0ff,stroke-width:2px,color:#e2e8f0
    style MM1 fill:#151d2e,stroke:#ffaa00,stroke-width:2px,color:#e2e8f0
    style MM2 fill:#151d2e,stroke:#ffaa00,stroke-width:2px,color:#e2e8f0
    style MM3 fill:#151d2e,stroke:#ffaa00,stroke-width:1px,color:#94a3b8
    style D1 fill:#1a2438,stroke:#a78bfa,stroke-width:1px,color:#e2e8f0
    style D2 fill:#1a2438,stroke:#a78bfa,stroke-width:1px,color:#e2e8f0
    style D3 fill:#1a2438,stroke:#a78bfa,stroke-width:1px,color:#e2e8f0
